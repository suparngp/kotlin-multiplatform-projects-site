<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Overview | Suparnatural Kotlin Multiplatform</title>
    <meta name="description" content="Suparnatural Projects for Kotlin Multiplatform apps">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.9c3cde5b.css" as="style"><link rel="preload" href="/assets/js/app.ade18f6d.js" as="script"><link rel="preload" href="/assets/js/2.6d64a48b.js" as="script"><link rel="preload" href="/assets/js/5.5989c2b3.js" as="script"><link rel="prefetch" href="/assets/js/10.c8ab61d0.js"><link rel="prefetch" href="/assets/js/11.260623ce.js"><link rel="prefetch" href="/assets/js/12.5fab1112.js"><link rel="prefetch" href="/assets/js/13.37140cfd.js"><link rel="prefetch" href="/assets/js/3.b94af3a5.js"><link rel="prefetch" href="/assets/js/4.d52a1680.js"><link rel="prefetch" href="/assets/js/6.f7706dd1.js"><link rel="prefetch" href="/assets/js/7.2e807871.js"><link rel="prefetch" href="/assets/js/8.15ae6700.js"><link rel="prefetch" href="/assets/js/9.4f77bb8d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9c3cde5b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/logo.png" alt="Suparnatural Kotlin Multiplatform" class="logo"> <span class="site-name can-hide">Suparnatural Kotlin Multiplatform</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>suparnatural-graphql</span> <!----></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/graphql/" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/graphql/#motivation" class="sidebar-link">Motivation</a></li><li class="sidebar-sub-header"><a href="/graphql/#features" class="sidebar-link">Features</a></li><li class="sidebar-sub-header"><a href="/graphql/#components" class="sidebar-link">Components</a></li><li class="sidebar-sub-header"><a href="/graphql/#limitations" class="sidebar-link">Limitations</a></li><li class="sidebar-sub-header"><a href="/graphql/#inspiration-credits" class="sidebar-link">Inspiration &amp; Credits</a></li></ul></li><li><a href="/graphql/installation.html" class="sidebar-link">Installation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/graphql/installation.html#kotlinx-serialization" class="sidebar-link">Kotlinx Serialization</a></li><li class="sidebar-sub-header"><a href="/graphql/installation.html#apply-gradle-plugin" class="sidebar-link">Apply Gradle Plugin</a></li><li class="sidebar-sub-header"><a href="/graphql/installation.html#configure-gradle-plugin" class="sidebar-link">Configure Gradle Plugin</a></li><li class="sidebar-sub-header"><a href="/graphql/installation.html#add-library" class="sidebar-link">Add Library</a></li><li class="sidebar-sub-header"><a href="/graphql/installation.html#rx-runtime" class="sidebar-link">RX Runtime</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/graphql/installation.html#custom-rx-runtime" class="sidebar-link">Custom RX Runtime</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Concepts</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/graphql/concepts.html" class="active sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/graphql/concepts.html#architecture" class="sidebar-link">Architecture</a></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#operation" class="sidebar-link">Operation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/graphql/concepts.html#operation-context" class="sidebar-link">Operation Context</a></li></ul></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#fetcher" class="sidebar-link">Fetcher</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/graphql/concepts.html#ktor-fetcher" class="sidebar-link">Ktor Fetcher</a></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#okhttp-fetcher" class="sidebar-link">OkHttp Fetcher</a></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#nsurlsession-fetcher" class="sidebar-link">NSURLSession Fetcher</a></li></ul></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#link" class="sidebar-link">Link</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/graphql/concepts.html#composition" class="sidebar-link">Composition</a></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#link-execution" class="sidebar-link">Link Execution</a></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#terminating-link" class="sidebar-link">Terminating Link</a></li></ul></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#client" class="sidebar-link">Client</a></li><li class="sidebar-sub-header"><a href="/graphql/concepts.html#example" class="sidebar-link">Example</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h1> <p><code>suparnatural-graphql</code> consists of a couple of different components which together provide a delightful
developer experience when working with GraphQL. Those components and related concepts are in the following
sections.</p> <h2 id="architecture"><a href="#architecture" class="header-anchor">#</a> Architecture</h2> <p>The diagram below gives a high level overview of how various components are layered and interact with each other. By default, the package provides <code>JsonHttp</code> prefixed implementations of these components.</p> <p><img src="/assets/img/overall-architecture.4264ae3a.svg" alt="An image"></p> <h2 id="operation"><a href="#operation" class="header-anchor">#</a> Operation</h2> <p>A <code>GraphQlOperation</code> instance represents an operation to be performed against a GraphQL server. For every operation processed
by the <code>gradle</code> plugin, a class implementing <code>GraphQLOpertion</code> is created. The operation arguments can be passsed in the constructor. To perform any operation, simply create an instance of the required operation class and pass it to the <code>client</code>.</p> <p>The <code>jsonString</code> property returns a serialized <code>JSON</code> which can be sent to the GraphQL server. Therefore, the operation instance can be used with any <code>JSON</code> supported client directly. The response is deserialized by using <code>responseDeserializer</code> property which maps the raw <code>JSON</code> into strict types.</p> <h3 id="operation-context"><a href="#operation-context" class="header-anchor">#</a> Operation Context</h3> <p>A <code>GraphQlOperation</code> instance has a shared map <code>context</code> which can be used to keep <code>metadata</code>. For example, <code>context</code> can hold a <code>boolean</code> to decide whether to track this operation in your analytics engine. The <code>context</code> map combined with <code>Link</code> chain give a lot of power and flexibility to isolate logic tied to GraphQL from business logic which would otherwise spill over into business logic. The <code>context</code> is not type checked in order to provide the maximum amount of flexibility. However, you can store a typed object as a value in the map and later retrieve it if you want type safe context.</p> <h2 id="fetcher"><a href="#fetcher" class="header-anchor">#</a> Fetcher</h2> <p>A <code>Fetcher</code> fetches resources from a server. <code>HttpFetcher</code> is a <code>Fetcher</code> which works with <code>Http</code> and a <code>JsonHttpFetcher</code> is an <code>HttpFetcher</code> which works with <code>JSON</code> string payloads for both request and response body. You can think of <code>Fetcher</code> as your usual rest client.</p> <p>Generally, client libraries come bundled with a fetcher implementation. For example, <a href="https://www.apollographql.com/docs/ios/fetching-queries/#creating-queries" target="_blank" rel="noopener noreferrer">apollo-ios<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> comes with a built-in <code>fetch</code> implementation. However, such a &quot;works out of the box&quot; approach may not be suitable for projects of all complexity levels. Following examples highlight such limitations:</p> <ol><li>You may want to pin and verify certificates before making a network request.</li> <li>You are already using a networking client and configured it in a special way which should be carried on to the GraphQL requests.</li> <li>Your project / company / clients only trusts one networking library for security.</li></ol> <p>That is why, the default <code>JsonHttp</code> implementation of client doesn't make any assumption on how you implement the network transport as long as your implementation conforms with the <code>JsonHttpFetcher</code> interface. You can apply the same concept to your custom client implementations.</p> <p>Below are some examples of how fetcher can be implemented on different platforms</p> <h3 id="ktor-fetcher"><a href="#ktor-fetcher" class="header-anchor">#</a> <a href="https://ktor.io/clients/index.html" target="_blank" rel="noopener noreferrer">Ktor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> Fetcher</h3> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> KtorFetcher <span class="token operator">:</span> JsonHttpFetcher <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
        request<span class="token operator">:</span> JsonHttpFetchRequest<span class="token punctuation">,</span>
        handler<span class="token operator">:</span> <span class="token punctuation">(</span>JsonHttpFetchResponse<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// launch fetch in background</span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> client <span class="token operator">=</span> <span class="token function">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token operator">&lt;</span>HttpResponse<span class="token operator">&gt;</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token function">TextContent</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>body <span class="token operator">?:</span> <span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> contentType <span class="token operator">=</span> ContentType<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>Json<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">val</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">readText</span><span class="token punctuation">(</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">handler</span><span class="token punctuation">(</span><span class="token function">JsonHttpFetchResponse</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> response<span class="token punctuation">.</span>status<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> ClientRequestException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> body <span class="token operator">=</span> e<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">readText</span><span class="token punctuation">(</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token function">handler</span><span class="token punctuation">(</span><span class="token function">JsonHttpFetchResponse</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> e<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status<span class="token punctuation">.</span>value<span class="token punctuation">,</span> e<span class="token punctuation">.</span>localizedMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">handler</span><span class="token punctuation">(</span><span class="token function">JsonHttpFetchResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>localizedMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="okhttp-fetcher"><a href="#okhttp-fetcher" class="header-anchor">#</a> OkHttp Fetcher</h3> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> OkHttpFetcher <span class="token operator">:</span> JsonHttpFetcher <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token operator">:</span> JsonHttpFetchRequest<span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">(</span>JsonHttpFetchResponse<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> client <span class="token operator">=</span> <span class="token function">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> body <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>body <span class="token operator">?:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toRequestBody</span><span class="token punctuation">(</span><span class="token string">&quot;application/json; charset=utf-8&quot;</span><span class="token punctuation">.</span><span class="token function">toMediaType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> r <span class="token operator">=</span> Request<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> thread <span class="token operator">=</span> <span class="token function">HandlerThread</span><span class="token punctuation">(</span><span class="token string">&quot;okhttp&quot;</span><span class="token punctuation">)</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> h <span class="token operator">=</span> <span class="token function">Handler</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span>looper<span class="token punctuation">)</span>
        h<span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{</span>
            client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> responseBody <span class="token operator">=</span> it<span class="token punctuation">.</span>body<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">handler</span><span class="token punctuation">(</span><span class="token function">JsonHttpFetchResponse</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">,</span> it<span class="token punctuation">.</span>code<span class="token punctuation">,</span> it<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="nsurlsession-fetcher"><a href="#nsurlsession-fetcher" class="header-anchor">#</a> NSURLSession Fetcher</h3> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> IOSFetcher <span class="token operator">:</span> JsonHttpFetcher <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token operator">:</span> JsonHttpFetchRequest<span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token punctuation">(</span>JsonHttpFetchResponse<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NsUrlSessionFetcher</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// convert MutableData to NSData</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> MutableData<span class="token punctuation">.</span><span class="token function">asNSData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">withPointerLocked</span> <span class="token punctuation">{</span> it<span class="token punctuation">,</span> size <span class="token operator">-&gt;</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> NSMutableData<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>length <span class="token operator">=</span> size<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!!</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>mutableBytes<span class="token punctuation">,</span> it<span class="token punctuation">,</span> size<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    result
<span class="token punctuation">}</span>

<span class="token comment">// NSURLSession based fetch which operates on a background queue</span>
<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token function">NsUrlSessionFetcher</span><span class="token punctuation">(</span><span class="token keyword">val</span> handler<span class="token operator">:</span> <span class="token punctuation">(</span>JsonHttpFetchResponse<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">NSObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    NSURLSessionDataDelegateProtocol <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> asyncQueue <span class="token operator">=</span> <span class="token function">NSOperationQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> receivedData <span class="token operator">=</span> <span class="token function">MutableData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">init</span> <span class="token punctuation">{</span>
        <span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token operator">:</span> JsonHttpFetchRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        receivedData<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> session <span class="token operator">=</span> NSURLSession<span class="token punctuation">.</span><span class="token function">sessionWithConfiguration</span><span class="token punctuation">(</span>
            NSURLSessionConfiguration<span class="token punctuation">.</span><span class="token function">defaultSessionConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span>
            delegateQueue <span class="token operator">=</span> asyncQueue
        <span class="token punctuation">)</span>
        <span class="token keyword">val</span> url <span class="token operator">=</span> NSURL<span class="token punctuation">.</span><span class="token function">URLWithString</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token operator">!!</span>
        <span class="token keyword">val</span> r <span class="token operator">=</span> NSMutableURLRequest<span class="token punctuation">.</span><span class="token function">requestWithURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        r<span class="token punctuation">.</span>HTTPMethod <span class="token operator">=</span> <span class="token string">&quot;POST&quot;</span>
        r<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Accept&quot;</span><span class="token punctuation">)</span>
        r<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>headers<span class="token operator">?</span><span class="token punctuation">.</span>entries<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>value<span class="token punctuation">,</span> it<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>HTTPBody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>body <span class="token operator">?:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> NSString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dataUsingEncoding</span><span class="token punctuation">(</span>NSUTF8StringEncoding<span class="token punctuation">)</span>
        session<span class="token punctuation">.</span><span class="token function">dataTaskWithRequest</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">URLSession</span><span class="token punctuation">(</span>session<span class="token operator">:</span> NSURLSession<span class="token punctuation">,</span> dataTask<span class="token operator">:</span> NSURLSessionDataTask<span class="token punctuation">,</span> didReceiveData<span class="token operator">:</span> NSData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initRuntimeIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        receivedData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>didReceiveData<span class="token punctuation">.</span>bytes<span class="token punctuation">,</span> didReceiveData<span class="token punctuation">.</span>length<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">URLSession</span><span class="token punctuation">(</span>session<span class="token operator">:</span> NSURLSession<span class="token punctuation">,</span> task<span class="token operator">:</span> NSURLSessionTask<span class="token punctuation">,</span> didCompleteWithError<span class="token operator">:</span> NSError<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initRuntimeIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">val</span> response <span class="token operator">=</span> task<span class="token punctuation">.</span>response <span class="token keyword">as</span><span class="token operator">?</span> NSHTTPURLResponse
        <span class="token comment">// process error.  Of course, handling should be better. :)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>didCompleteWithError <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handler</span><span class="token punctuation">(</span><span class="token function">JsonHttpFetchResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> didCompleteWithError<span class="token punctuation">.</span>localizedDescription<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// process response. Of course, handling should be better. :)</span>
        <span class="token keyword">val</span> statusCode <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>response <span class="token keyword">as</span> NSHTTPURLResponse<span class="token punctuation">)</span><span class="token punctuation">.</span>statusCode<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token operator">-</span><span class="token number">2</span>
        <span class="token keyword">val</span> statusMessage <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
        <span class="token keyword">val</span> body <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>receivedData<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> NSString<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>receivedData<span class="token punctuation">.</span><span class="token function">asNSData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NSUTF8StringEncoding<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token keyword">null</span>
        <span class="token function">handler</span><span class="token punctuation">(</span><span class="token function">JsonHttpFetchResponse</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> statusCode<span class="token punctuation">,</span> statusMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h2 id="link"><a href="#link" class="header-anchor">#</a> Link</h2> <p>Links are small composable units of logic which can be joined together to form a control flow chain. A link chain is also a link which can be futher extended. Each <code>Link&lt;A, T, V&gt;</code> has only one method <code>execute</code> which takes an input of type <code>A</code> and returns an observable of type <code>V</code>. A <code>GraphQlLink&lt;T, V&gt;</code> is a <code>Link</code> which takes a <code>GraphQlOperation</code> as an input and returns an observable of type <code>V</code>. We will cover the type <code>T</code> in the next section.</p> <h3 id="composition"><a href="#composition" class="header-anchor">#</a> Composition</h3> <p>Several links can be combined linearly to form a chain. <code>Link</code> operators like <code>split</code> allow you to create complex control flows. For example, a link in the chain can add some tracking metadata to the operation context. A subsequent link in the chain can then extract that metadata and track the request metrics in your analytics service. Two links <code>link1: Link&lt;A, T, V&gt;</code> and <code>link2: Link&lt;A, B, C&gt;</code> can be chained by using <code>chain = link1.concat(link2)</code> if and only if the type <code>T</code> and <code>C</code> are the same. This provides a compile time guarantee that <code>link1</code> will be able to post process the observable response from <code>link2</code>.  The following diagram describes the concept of a link chain.</p> <p><img src="/assets/img/link.afbbb8df.svg" alt="An image"></p> <h3 id="link-execution"><a href="#link-execution" class="header-anchor">#</a> Link Execution</h3> <p>A Link acts both as a middleware and an afterware. It can perform side effects on the operation before the request goes to GraphQL server and can also process the response returned from the server or the next link. The <code>GraphQlLink.execute</code> method takes two arguments; a <code>GraphQlOperation</code> instance and the <code>next</code> <code>GraphQlLink</code> instance in the chain. The link can then process the operation and call the <code>execute</code> method of the next link in the chain if present. Since the value returned from <code>next.execute</code> is also an observable, the calling link can post process the received value and return a new value instead.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> CustomLink <span class="token operator">:</span> Link<span class="token operator">&lt;</span>GraphQlLink<span class="token punctuation">,</span> TypeA<span class="token punctuation">,</span> TypeB<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">execute</span><span class="token punctuation">(</span>operation<span class="token operator">:</span> GraphQlOperation<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> next<span class="token operator">:</span> Link<span class="token operator">&lt;</span>GraphQlOperation<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> TypeA<span class="token operator">&gt;</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>TypeB<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// middleware - modify the operation before sending to next link</span>
        operation<span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;value&quot;</span>

        <span class="token comment">// afterware - wait for the response from next link and post process it</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>next<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token function">observableOf</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span>
            <span class="token comment">//post process the response</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="terminating-link"><a href="#terminating-link" class="header-anchor">#</a> Terminating Link</h3> <p>The last link in the chain receives <code>null</code> value for <code>next</code> argument in <code>execute</code>. It is expected that a terminating link returns an observable which contains GraphQL server response. <code>JsonHttpGraphQlLink</code> is a terminating link which sends a JSON request using the provided <code>JsonHttpFetcher</code> implementation and returns an observable of type <code>JsonHttpFetchResponse</code>.</p> <h2 id="client"><a href="#client" class="header-anchor">#</a> Client</h2> <p>A client executes an operation against a GraphQl server and returns an <code>Observable</code>. It accepts a chain of <code>Link</code> which emits the final response of type <code>T</code>. The client should not concern itself with how to make a network request. Rather, it should rely on the last <code>Link</code> of the <code>chain</code> as terminating link which fetches the response from the server. <code>JsonHttpGraphQlLink</code> is one such link. The client should then take the response as input and transform it into the correct response type based on the operation.</p> <p>The <code>Observable</code> returned from <code>execute</code> returns an instance of <code>Result</code> for both success and failure responses and thus, it never throws an error. This is intentional as the underlying <code>Observable</code> implementation may change in the upcoming released. This should ensure that such a change won't break your application.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code>client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span> <span class="token punctuation">{</span>
    <span class="token keyword">when</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">is</span> Result<span class="token punctuation">.</span>Success <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; Successful <span class="token interpolation"><span class="token delimiter variable">${</span>it<span class="token punctuation">.</span>value<span class="token punctuation">.</span>data<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">is</span> Result<span class="token punctuation">.</span>Failure <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Failed <span class="token interpolation"><span class="token delimiter variable">${</span>it<span class="token punctuation">.</span>value<span class="token punctuation">.</span>error<span class="token delimiter variable">}</span></span> <span class="token interpolation"><span class="token delimiter variable">${</span>it<span class="token punctuation">.</span>value<span class="token punctuation">.</span>response<span class="token delimiter variable">}</span></span> <span class="token interpolation"><span class="token delimiter variable">${</span>it<span class="token punctuation">.</span>cause<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="example"><a href="#example" class="header-anchor">#</a> Example</h2> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> ktorFetcher <span class="token operator">=</span> <span class="token function">KtorFetcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> httpLink <span class="token operator">=</span> <span class="token function">JsonHttpGraphQlLink</span><span class="token punctuation">(</span>ktorFetcher<span class="token punctuation">,</span> <span class="token string">&quot;https://countries.trevorblades.com&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> client <span class="token operator">=</span> <span class="token function">JsonHttpGraphQlClient</span><span class="token punctuation">(</span>httpLink<span class="token punctuation">)</span>
    <span class="token keyword">val</span> operation <span class="token operator">=</span> Operations<span class="token punctuation">.</span><span class="token function">Countries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// generated by plugin</span>

    client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span> <span class="token punctuation">{</span>
            <span class="token keyword">when</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">is</span> Result<span class="token punctuation">.</span>Success <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; Successful <span class="token interpolation"><span class="token delimiter variable">${</span>it<span class="token punctuation">.</span>value<span class="token punctuation">.</span>data<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">is</span> Result<span class="token punctuation">.</span>Failure <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Failed <span class="token interpolation"><span class="token delimiter variable">${</span>it<span class="token punctuation">.</span>value<span class="token punctuation">.</span>error<span class="token delimiter variable">}</span></span> <span class="token interpolation"><span class="token delimiter variable">${</span>it<span class="token punctuation">.</span>value<span class="token punctuation">.</span>response<span class="token delimiter variable">}</span></span> <span class="token interpolation"><span class="token delimiter variable">${</span>it<span class="token punctuation">.</span>cause<span class="token delimiter variable">}</span></span>&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    runBlocking <span class="token punctuation">{</span>
        kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/graphql/installation.html" class="prev">Installation</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ade18f6d.js" defer></script><script src="/assets/js/2.6d64a48b.js" defer></script><script src="/assets/js/5.5989c2b3.js" defer></script>
  </body>
</html>
