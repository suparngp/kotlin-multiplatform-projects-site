<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>suparnatural-concurrency | Suparnatural Kotlin Multiplatform</title>
    <meta name="description" content="Suparnatural Projects for Kotlin Multiplatform apps">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.9c3cde5b.css" as="style"><link rel="preload" href="/assets/js/app.ade18f6d.js" as="script"><link rel="preload" href="/assets/js/2.6d64a48b.js" as="script"><link rel="preload" href="/assets/js/9.4f77bb8d.js" as="script"><link rel="prefetch" href="/assets/js/10.c8ab61d0.js"><link rel="prefetch" href="/assets/js/11.260623ce.js"><link rel="prefetch" href="/assets/js/12.5fab1112.js"><link rel="prefetch" href="/assets/js/13.37140cfd.js"><link rel="prefetch" href="/assets/js/3.b94af3a5.js"><link rel="prefetch" href="/assets/js/4.d52a1680.js"><link rel="prefetch" href="/assets/js/5.5989c2b3.js"><link rel="prefetch" href="/assets/js/6.f7706dd1.js"><link rel="prefetch" href="/assets/js/7.2e807871.js"><link rel="prefetch" href="/assets/js/8.15ae6700.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9c3cde5b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/logo.png" alt="Suparnatural Kotlin Multiplatform" class="logo"> <span class="site-name can-hide">Suparnatural Kotlin Multiplatform</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/concurrency/" class="active sidebar-link">suparnatural-concurrency</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/concurrency/#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/concurrency/#setup" class="sidebar-link">Setup</a></li><li class="sidebar-sub-header"><a href="/concurrency/#usage" class="sidebar-link">Usage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/concurrency/#worker" class="sidebar-link">Worker</a></li><li class="sidebar-sub-header"><a href="/concurrency/#locks" class="sidebar-link">Locks</a></li><li class="sidebar-sub-header"><a href="/concurrency/#jobdispatcher" class="sidebar-link">JobDispatcher</a></li><li class="sidebar-sub-header"><a href="/concurrency/#immutability-property-delegate" class="sidebar-link">Immutability Property Delegate</a></li><li class="sidebar-sub-header"><a href="/concurrency/#utilities" class="sidebar-link">Utilities</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="suparnatural-concurrency"><a href="#suparnatural-concurrency" class="header-anchor">#</a> suparnatural-concurrency</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>This library provides convenient methods and common implementations to simplify
concurrency/multi-threading in Kotlin Multiplatform projects for <code>iOS</code> and <code>Android</code>.</p> <p>This package is intended to unify the concurrency patterns on all the platforms.
For example, Native concurrency is different than how JVM works thus in many
cases, it may be hard to write common code without platform specific considerations.</p> <p>In such cases, this package is useful because it provides a common unified API
for many similar constructs by choosing the most restrictive ones.</p> <p>For example, in case of Native, any background operations must use a non-state
capturing lambda where as JVM does not impose such restrictions. Therefore,
the <code>Worker</code> API in this package exposes and implementation based on the former expectation.</p> <h2 id="setup"><a href="#setup" class="header-anchor">#</a> Setup</h2> <ol><li>Add the repository to your project.<div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>repositories <span class="token punctuation">{</span>
    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li>Add <code>implementation 'com.suparnatural.kotlin:concurrency:version'</code> to <code>commonMain</code>.</li></ol> <blockquote><p>With the hierarchical project structure, you generally need to add the dependency to <code>commonMain</code> only. Other targets are also available in case you need to override this behavior.</p></blockquote> <h2 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h2> <p>Check out the <a href="https://suparngp.github.io/kotlin-multiplatform-projects/concurrency/docs/suparnatural-concurrency/index.html" target="_blank" rel="noopener noreferrer">API Docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
They are always up to date with code examples.</p> <h3 id="worker"><a href="#worker" class="header-anchor">#</a> Worker</h3> <p><code>Worker</code> presents a unified API across all platforms to interact with threads.
A <code>Worker</code> can execute a job in its event loop. If needed, it can also resume the
flow on a different worker instance. All threads including <code>main</code> are exposed
via this API. For example, to get a <code>Worker</code> backed by <code>main</code> thread, use
<code>WorkerFactory.main</code>.</p> <p>A worker <code>job</code> must satisfy the following requirements:</p> <ol><li>The <code>job</code> must be a non state capturing lambda which does not capture any outside state.</li> <li>Any input required by the <code>job</code> must be passed before hand in the <code>execute</code> or <code>executeAndResume</code> method
<code>jobInput</code> parameters.</li> <li>The <code>job</code> input arguments must be treated as immutable to guarantee thread safety.</li></ol> <p>The basic idea behind worker is to bring the same level of abstraction to every platform as Native has
because native concurrency is the most restrictive one.</p> <p>On iOS, it uses the Kotlin/Native's <code>Worker</code> API.
On Android, it uses <code>Handler</code>.</p> <h4 id="run-job-on-background-worker"><a href="#run-job-on-background-worker" class="header-anchor">#</a> Run job on background Worker</h4> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> worker <span class="token operator">=</span> WorkerFactory<span class="token punctuation">.</span><span class="token function">newBackgroundThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// calling execute schedules a task on worker</span>
<span class="token keyword">val</span> future <span class="token operator">=</span> worker<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>it<span class="token operator">:</span> String <span class="token operator">-&gt;</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span>
  <span class="token string">&quot;World&quot;</span>
<span class="token punctuation">}</span>


<span class="token comment">// wait for worker to complete, use await</span>
<span class="token keyword">val</span> result<span class="token operator">:</span> String <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="resume-job-on-a-different-worker"><a href="#resume-job-on-a-different-worker" class="header-anchor">#</a> Resume job on a different Worker</h4> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> worker1 <span class="token operator">=</span> WorkerFactory<span class="token punctuation">.</span><span class="token function">newBackgroundWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> worker2 <span class="token operator">=</span> WorkerFactory<span class="token punctuation">.</span><span class="token function">newBackgroundWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> future <span class="token operator">=</span> worker2<span class="token punctuation">.</span><span class="token function">executeAndResume</span><span class="token punctuation">(</span>INPUT<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span>INPUT<span class="token punctuation">,</span> it<span class="token punctuation">)</span>
  OUTPUT
<span class="token punctuation">}</span><span class="token punctuation">,</span> worker1<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span>OUTPUT<span class="token punctuation">,</span> it<span class="token punctuation">)</span>
  it
<span class="token punctuation">}</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span>OUTPUT<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="resume-job-on-main-worker"><a href="#resume-job-on-main-worker" class="header-anchor">#</a> Resume Job on main worker</h4> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> worker <span class="token operator">=</span> WorkerFactory<span class="token punctuation">.</span><span class="token function">newBackgroundWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> future <span class="token operator">=</span> worker<span class="token punctuation">.</span><span class="token function">executeAndResume</span><span class="token punctuation">(</span>INPUT<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span>INPUT<span class="token punctuation">,</span> it<span class="token punctuation">)</span>
  OUTPUT
<span class="token punctuation">}</span><span class="token punctuation">,</span> awaitResumingJob <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// called on main thread asynchronously</span>
  <span class="token function">assertEquals</span><span class="token punctuation">(</span>OUTPUT<span class="token punctuation">,</span> it<span class="token punctuation">)</span>
  it
<span class="token punctuation">}</span>

<span class="token comment">// do not call future.await because it will block main thread.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="locks"><a href="#locks" class="header-anchor">#</a> Locks</h3> <h4 id="read-write-lock"><a href="#read-write-lock" class="header-anchor">#</a> Read Write Lock</h4> <p><a href="https://suparngp.github.io/kotlin-multiplatform-projects/concurrency/docs/suparnatural-concurrency/com.suparnatural.core.concurrency/-read-write-lock/index.html" target="_blank" rel="noopener noreferrer"><code>ReadWriteLock</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> allows multiple readers to read a shared memory or a single thread to mutate it.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> lock <span class="token operator">=</span> <span class="token function">ReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// read from multiple threads simultaneously.</span>
lock<span class="token punctuation">.</span><span class="token function">acquireReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// call from as many threads</span>

<span class="token comment">// perform read ....</span>

lock<span class="token punctuation">.</span><span class="token function">releaseReadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// to protect writes</span>
lock<span class="token punctuation">.</span><span class="token function">acquireWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// only one thread will get lock, others will be blocked.</span>

<span class="token comment">// perform write ....</span>

lock<span class="token punctuation">.</span><span class="token function">releaseWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// next thread will now unblock.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="mutex-lock"><a href="#mutex-lock" class="header-anchor">#</a> Mutex Lock</h4> <p><a href="https://suparngp.github.io/kotlin-multiplatform-projects/concurrency/docs/concurrency/com.suparnatural.core.concurrency/-mutex/index.html" target="_blank" rel="noopener noreferrer"><code>MutexLock</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a locking mechanism which allows only one thread to gain access to a resource protected by an instance of [MutexLock]. If more than one thread tries to acquire <code>lock</code>, only the first thread is successful while the other threads either wait or return depending on whether <code>lock</code> or <code>tryLock</code> was invoked.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> mutex <span class="token operator">=</span> <span class="token function">MutexLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">assertFalse</span><span class="token punctuation">(</span>mutex<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> future <span class="token operator">=</span> WorkerFactory<span class="token punctuation">.</span><span class="token function">newBackgroundWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assertFalse</span><span class="token punctuation">(</span>mutex<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
future<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mutex<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="jobdispatcher"><a href="#jobdispatcher" class="header-anchor">#</a> JobDispatcher</h3> <p>Use <a href="https://suparngp.github.io/kotlin-multiplatform-projects/concurrency/docs/suparnatural-concurrency/com.suparnatural.core.concurrency/-job-dispatcher/index.html" target="_blank" rel="noopener noreferrer"><code>JobDispatcher</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to dispatch a task on main or background thread.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> future <span class="token operator">=</span> JobDispatcher<span class="token punctuation">.</span><span class="token function">dispatchOnMainThread</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>it<span class="token operator">:</span> String <span class="token operator">-&gt;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span> <span class="token comment">// runs on main thread</span>
<span class="token punctuation">}</span>
future<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> future <span class="token operator">=</span> JobDispatcher<span class="token punctuation">.</span><span class="token function">dispatchOnBackgroundThread</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>it<span class="token operator">:</span> String <span class="token operator">-&gt;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span> <span class="token comment">// runs on background thread</span>
<span class="token punctuation">}</span>
future<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="immutability-property-delegate"><a href="#immutability-property-delegate" class="header-anchor">#</a> Immutability Property Delegate</h3> <p>Any property can be made thread safe by using <a href="https://suparngp.github.io/kotlin-multiplatform-projects/concurrency/docs/suparnatural-concurrency/com.suparnatural.core.concurrency/-immutability/index.html" target="_blank" rel="noopener noreferrer"><code>Immutability</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> property delegate.
Such properties are internally backed by <a href="https://suparngp.github.io/kotlin-multiplatform-projects/concurrency/docs/suparnatural-concurrency/com.suparnatural.core.concurrency/-atomic-reference/index.html" target="_blank" rel="noopener noreferrer"><code>AtomicReference</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> but it remains transparent to the rest of the code.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// Since top level objects are always immutable, they can be accessed from any thread.</span>
<span class="token keyword">object</span> SharedObject<span class="token punctuation">{</span>

<span class="token keyword">val</span> person<span class="token operator">:</span> Person<span class="token operator">?</span> <span class="token keyword">by</span> Immutability<span class="token operator">&lt;</span>Person<span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>initialValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

  <span class="token keyword">fun</span> <span class="token function">initialize</span><span class="token punctuation">(</span>p<span class="token operator">:</span> Person<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// any thread can now atomically update the person property.</span>
    person <span class="token operator">=</span> p <span class="token comment">// will succeed</span>
    person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>  <span class="token comment">// will cause error</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> MyClass <span class="token punctuation">{</span>
  <span class="token keyword">val</span> value<span class="token operator">:</span> Int <span class="token keyword">by</span> Immutability<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span>initialValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// can be called from any thread as long as instance is thread shareable.</span>
instance<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="utilities"><a href="#utilities" class="header-anchor">#</a> Utilities</h3> <h4 id="make-objects-thread-shareable"><a href="#make-objects-thread-shareable" class="header-anchor">#</a> Make objects thread shareable</h4> <p>Use <a href="https://suparngp.github.io/kotlin-multiplatform-projects/concurrency/docs/suparnatural-concurrency/com.suparnatural.core.concurrency/to-immutable.html" target="_blank" rel="noopener noreferrer"><code>toImmutable</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to make objects immutable and thus shareable across threads.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> person <span class="token operator">=</span> <span class="token function">Person</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;Bob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toImmutable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Jerry&quot;</span> <span class="token comment">// error</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="check-if-current-thread-is-main-thread"><a href="#check-if-current-thread-is-main-thread" class="header-anchor">#</a> Check if current thread is main thread</h4> <p>Use <a href=""><code>isMainThread</code></a> to check whether current thread is main or not.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>JobDispatcher.dispatchOnMainThread(Unit) {
   assertTrue(isMainThread())
}

JobDispatcher.dispatchOnBackgroundThread(Unit) {
   assertFalse(isMainThread())
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ade18f6d.js" defer></script><script src="/assets/js/2.6d64a48b.js" defer></script><script src="/assets/js/9.4f77bb8d.js" defer></script>
  </body>
</html>
